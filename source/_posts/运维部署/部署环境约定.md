---
title: 部署环境约定
date: '2020-04-18 11:00:00'
# update: '2020-04-21 02:34:40'
comments: true
categories: [运维部署]
tags:
  - 运维
  - 部署
  - 集群
  - Docker
  - NFS
---

# 环境约定

> Convention over Configuration.

关于服务器部署的一些约定。

# NFS 服务相关

1. NFS 服务用于在 Docker Swarm 中的数据共享，包括但不限于配置文件共享、数据共享等；
2. NFS 服务提供节点应当尽可能少的承担其他存储服务（如下载服务），专注于提供 NFS 服务；
3. NFS 服务仅允许已授权的访问，规定所有访问映射为匿名用户 nfsnobody，避免权限问题；
4. NFS 服务禁止所有未授权的访问，包括匿名只读；
5. NFS 服务节点上的共享目录位置为：`/mnt/network`，在消费节点的挂载目录为：`/app`；
6. NFS 应当在服务节点上以宿主进程的形式提供服务，而不是 Docker 容器形式。

示范配置如下：

### `/etc/exports` 映射配置

```config
/mnt/network/$region1 $client1(rw,async,no_subtree_check,all_squash,anonuid=0,anongid=0,insecure)
/mnt/network/$region2 $client2(rw,async,no_subtree_check,all_squash,anonuid=0,anongid=0,insecure)
```

其中，`$region1` 为 `$client1` 对应的地区，以此类推。

### `/etc/fstab` 挂载配置

```config
nfs.server.com:/mnt/network/$region /app nfs nfsvers=4,minorversion=1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,_netdev,noresvport 0 0
```

其中，`$region` 为部署地区，即当前节点所属的地区。

约定的地区代码应当由四位大写英文字母组成（如 `ALHK`）。前两个字母代表云服务提供商（`AL` => 阿里云，`GC` => Google Cloud，`GD` => GoDaddy，`RP` => Raspberry Pi，`TC` => 腾讯云，`VU` => Vultr 等）；后两个字母为地区英文缩写（详见[信息产业部关于调整中国互联网络域名体系的公告](http://www.gov.cn/gzdt/2006-02/24/content_210497_2.htm)），比如`HK` 香港、`HI` 海南等。

# 数据目录相关

1. 在整个独立集群中，服务名应当是唯一的，应当使用服务名为数据目录命名，如 `/app/mongo`、`/app/mysql`、`/app/minio` 等。

2. 对于一个独立的服务目录，其子目录的命名应当遵循如下对应规则：

   配置 => `config`

   数据 => `data`

   日志 => `log`

   当然了，对于一些配置文件与数据文件混合第三方容器，直接把容器主目录映射到 `/app/name` 也是不错的选择。

3. 对于有本地存储需求的服务（如下载服务），应当使用 `/mnt/local` 作为本地存储目录；

4. 如果本机挂载了多个本地数据盘，则应当以 `/mnt/local1`、`/mnt/local2` 的方式进行命名；其中 `/mnt/local` 为本机系统盘（即默认存储介质）；

5. 对于有网络存储需求的服务（如大文件跨主机共享），应当使用 `/mnt/network` 作为网络存储目录；

6. 如果本机挂载了多个网络数据盘，则应当以 `/mnt/network1`、`/mnt/network2` 的方式进行命名；其中，`/mnt/network` 为本机向外提供共享服务的目录，即本地 NFS 共享目录（可能会拓展为其他网络存储服务，如 SMB 服务）。
