{"title":"部署环境约定","date":"2020-04-18T11:00:00.000Z","date_formatted":{"ll":"2020年4月18日","L":"2020/04/18","MM-DD":"04-18"},"link":"article/运维部署/部署环境约定","tags":["Docker","NFS","运维","部署","集群"],"categories":["运维部署"],"updated":"2020-04-18T03:00:00.000Z","content":"<h1 id=\"环境约定\">环境约定<a title=\"#环境约定\" href=\"#环境约定\"></a></h1>\n<blockquote>\n<p>Convention over Configuration.</p>\n</blockquote>\n<p>关于服务器部署的一些约定。</p>\n<h1 id=\"nfs-服务相关\">NFS 服务相关<a title=\"#nfs-服务相关\" href=\"#nfs-服务相关\"></a></h1>\n<ol>\n<li>NFS 服务用于在 Docker Swarm 中的数据共享，包括但不限于配置文件共享、数据共享等；</li>\n<li>NFS 服务提供节点应当尽可能少的承担其他存储服务（如下载服务），专注于提供 NFS 服务；</li>\n<li>NFS 服务仅允许已授权的访问，规定所有访问映射为匿名用户 nfsnobody，避免权限问题；</li>\n<li>NFS 服务禁止所有未授权的访问，包括匿名只读；</li>\n<li>NFS 服务节点上的共享目录位置为：<code>/mnt/network</code>，在消费节点的挂载目录为：<code>/app</code>；</li>\n<li>NFS 应当在服务节点上以宿主进程的形式提供服务，而不是 Docker 容器形式。</li>\n</ol>\n<p>示范配置如下：</p>\n<h3 id=\"/etc/exports-映射配置\"><code>/etc/exports</code> 映射配置<a title=\"#/etc/exports-映射配置\" href=\"#/etc/exports-映射配置\"></a></h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs config\">&#x2F;mnt&#x2F;network&#x2F;$region1 $client1(rw,async,no_subtree_check,all_squash,anonuid&#x3D;0,anongid&#x3D;0,insecure)<br>&#x2F;mnt&#x2F;network&#x2F;$region2 $client2(rw,async,no_subtree_check,all_squash,anonuid&#x3D;0,anongid&#x3D;0,insecure)<br></code></pre></td></tr></table></figure>\n<p>其中，<code>$region1</code> 为 <code>$client1</code> 对应的地区，以此类推。</p>\n<h3 id=\"/etc/fstab-挂载配置\"><code>/etc/fstab</code> 挂载配置<a title=\"#/etc/fstab-挂载配置\" href=\"#/etc/fstab-挂载配置\"></a></h3>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs config\">nfs.server.com:&#x2F;mnt&#x2F;network&#x2F;$region &#x2F;app nfs nfsvers&#x3D;4,minorversion&#x3D;1,rsize&#x3D;1048576,wsize&#x3D;1048576,hard,timeo&#x3D;600,retrans&#x3D;2,_netdev,noresvport 0 0<br></code></pre></td></tr></table></figure>\n<p>其中，<code>$region</code> 为部署地区，即当前节点所属的地区。</p>\n<p>约定的地区代码应当由四位大写英文字母组成（如 <code>ALHK</code>）。前两个字母代表云服务提供商（<code>AL</code> =&gt; 阿里云，<code>GC</code> =&gt; Google Cloud，<code>GD</code> =&gt; GoDaddy，<code>RP</code> =&gt; Raspberry Pi，<code>TC</code> =&gt; 腾讯云，<code>VU</code> =&gt; Vultr 等）；后两个字母为地区英文缩写（详见<a href=\"http://www.gov.cn/gzdt/2006-02/24/content_210497_2.htm\" target=\"_blank\">信息产业部关于调整中国互联网络域名体系的公告</a>），比如<code>HK</code> 香港、<code>HI</code> 海南等。</p>\n<h1 id=\"数据目录相关\">数据目录相关<a title=\"#数据目录相关\" href=\"#数据目录相关\"></a></h1>\n<ol>\n<li>\n<p>在整个独立集群中，服务名应当是唯一的，应当使用服务名为数据目录命名，如 <code>/app/mongo</code>、<code>/app/mysql</code>、<code>/app/minio</code> 等。</p>\n</li>\n<li>\n<p>对于一个独立的服务目录，其子目录的命名应当遵循如下对应规则：</p>\n<p>配置 =&gt; <code>config</code></p>\n<p>数据 =&gt; <code>data</code></p>\n<p>日志 =&gt; <code>log</code></p>\n<p>当然了，对于一些配置文件与数据文件混合第三方容器，直接把容器主目录映射到 <code>/app/name</code> 也是不错的选择。</p>\n</li>\n<li>\n<p>对于有本地存储需求的服务（如下载服务），应当使用 <code>/mnt/local</code> 作为本地存储目录；</p>\n</li>\n<li>\n<p>如果本机挂载了多个本地数据盘，则应当以 <code>/mnt/local1</code>、<code>/mnt/local2</code> 的方式进行命名；其中 <code>/mnt/local</code> 为本机系统盘（即默认存储介质）；</p>\n</li>\n<li>\n<p>对于有网络存储需求的服务（如大文件跨主机共享），应当使用 <code>/mnt/network</code> 作为网络存储目录；</p>\n</li>\n<li>\n<p>如果本机挂载了多个网络数据盘，则应当以 <code>/mnt/network1</code>、<code>/mnt/network2</code> 的方式进行命名；其中，<code>/mnt/network</code> 为本机向外提供共享服务的目录，即本地 NFS 共享目录（可能会拓展为其他网络存储服务，如 SMB 服务）。</p>\n</li>\n</ol>\n","prev":{"title":"分类测试","link":"article/测试"},"plink":"https://blog.don.com/article/运维部署/部署环境约定/","toc":[{"id":"环境约定","title":"环境约定","index":"1"},{"id":"nfs-服务相关","title":"NFS 服务相关","index":"2","children":[{"id":"/etc/exports-映射配置","title":"&#x2F;etc&#x2F;exports 映射配置","index":"2.1"},{"id":"/etc/fstab-挂载配置","title":"&#x2F;etc&#x2F;fstab 挂载配置","index":"2.2"}]}]}